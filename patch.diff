 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/lib/main.dart b/lib/main.dart
index 43b350600c4959a4960c5188b92f05462c981f5f..df9f1b07fbd057413832a6638a632ef454da8214 100644
--- a/lib/main.dart
+++ b/lib/main.dart
@@ -1315,50 +1315,66 @@ class _ModbusDashboardState extends State<ModbusDashboard> {
   }
 
   void _removeRange(int index) {
     if (index < 0 || index >= _ranges.length) {
       return;
     }
     setState(() {
       final RegisterRange range = _ranges.removeAt(index);
       _bank.removeRange(range.start, range.storageLength);
       final List<TextEditingController>? controllers = _rangeValueControllers
           .remove(range.start);
       if (controllers != null) {
         for (final TextEditingController controller in controllers) {
           controller.dispose();
         }
       }
       final List<FocusNode>? nodes = _rangeValueFocusNodes.remove(range.start);
       if (nodes != null) {
         for (final FocusNode node in nodes) {
           node.dispose();
         }
       }
     });
   }
 
+  void _reorderRanges(int fromIndex, int toIndex) {
+    if (fromIndex == toIndex ||
+        fromIndex < 0 ||
+        toIndex < 0 ||
+        fromIndex >= _ranges.length ||
+        toIndex >= _ranges.length) {
+      return;
+    }
+
+    setState(() {
+      final RegisterRange moved = _ranges.removeAt(fromIndex);
+      final int insertIndex = toIndex > fromIndex ? toIndex - 1 : toIndex;
+      _ranges.insert(insertIndex, moved);
+    });
+  }
+
   Future<void> _showAddRegisterDialog() async {
     final TextEditingController nameController = TextEditingController();
     final TextEditingController startController = TextEditingController();
     final TextEditingController lengthController = TextEditingController(
       text: '1',
     );
     final TextEditingController valueIndexController = TextEditingController(
       text: '0',
     );
 
     RegisterAccess access = RegisterAccess.readWrite;
     RegisterValueType valueType = RegisterValueType.word;
 
     final bool? shouldCreate = await showDialog<bool>(
       context: context,
       builder: (BuildContext context) {
         return AlertDialog(
           title: const Text('Добавить регистр'),
           content: SizedBox(
             width: 420,
             child: SingleChildScrollView(
               child: Column(
                 mainAxisSize: MainAxisSize.min,
                 children: <Widget>[
                   TextField(
@@ -2113,157 +2129,231 @@ class _ModbusDashboardState extends State<ModbusDashboard> {
                     itemCount: _ranges.length,
                     gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                       crossAxisCount: columns,
                       crossAxisSpacing: 8,
                       mainAxisSpacing: 8,
                       childAspectRatio: 2.3,
                     ),
                     itemBuilder: (BuildContext context, int index) {
                       final RegisterRange range = _ranges[index];
                       final bool changed = range.isChanged(
                         _bank,
                         highlightWindow,
                       );
                       _ensureRangeInputControllers(range);
                       final List<TextEditingController> valueControllers =
                           _rangeValueControllers[range.start] ??
                           <TextEditingController>[];
                       final List<FocusNode> focusNodes =
                           _rangeValueFocusNodes[range.start] ?? <FocusNode>[];
                       final List<int> currentValues =
                           _bank.readRangeRaw(
                             range.start,
                             range.storageLength,
                           ) ??
                           List<int>.filled(range.storageLength, 0);
-                      return Container(
-                        padding: const EdgeInsets.symmetric(
-                          horizontal: 8,
-                          vertical: 6,
-                        ),
-                        decoration: BoxDecoration(
-                          border: Border.all(color: Colors.white24),
-                          color: changed
-                              ? Colors.yellow.withValues(alpha: 0.18)
-                              : null,
-                        ),
-                        child: Column(
-                          crossAxisAlignment: CrossAxisAlignment.start,
-                          children: [
-                            Row(
-                              children: [
-                                Expanded(
-                                  child: Text(
-                                    '${range.name} | ${range.start} | ${range.typeLabel} | ${range.accessLabel}',
-                                    style: const TextStyle(
-                                      fontWeight: FontWeight.bold,
-                                      fontSize: 12,
-                                    ),
-                                    maxLines: 2,
-                                    overflow: TextOverflow.ellipsis,
-                                  ),
-                                ),
-                                IconButton(
-                                  visualDensity: VisualDensity.compact,
-                                  tooltip: 'Побитный редактор',
-                                  onPressed: () => _showBitEditor(range),
-                                  icon: const Icon(Icons.tune, size: 18),
+                      return DragTarget<int>(
+                        onWillAcceptWithDetails: (
+                          DragTargetDetails<int> details,
+                        ) {
+                          return details.data != index;
+                        },
+                        onAcceptWithDetails: (
+                          DragTargetDetails<int> details,
+                        ) {
+                          _reorderRanges(details.data, index);
+                        },
+                        builder: (
+                          BuildContext context,
+                          List<int?> candidateData,
+                          List<dynamic> rejectedData,
+                        ) {
+                          final bool isDropTarget = candidateData.isNotEmpty;
+                          return LongPressDraggable<int>(
+                            data: index,
+                            feedback: Material(
+                              color: Colors.transparent,
+                              child: ConstrainedBox(
+                                constraints: const BoxConstraints(
+                                  maxWidth: 360,
+                                  minWidth: 220,
                                 ),
-                                IconButton(
-                                  visualDensity: VisualDensity.compact,
-                                  onPressed: () => _removeRange(index),
-                                  icon: const Icon(
-                                    Icons.delete_outline,
-                                    size: 18,
+                                child: Opacity(
+                                  opacity: 0.88,
+                                  child: _buildRangeCard(
+                                    range: range,
+                                    index: index,
+                                    changed: changed,
+                                    valueControllers: valueControllers,
+                                    focusNodes: focusNodes,
+                                    currentValues: currentValues,
                                   ),
                                 ),
-                              ],
+                              ),
                             ),
-                            Expanded(
-                              child: ListView.builder(
-                                itemCount: valueControllers.length,
-                                itemBuilder: (BuildContext context, int row) {
-                                  final int addr = range.start + row;
-                                  final int value = row < currentValues.length
-                                      ? currentValues[row]
-                                      : 0;
-                                  return Padding(
-                                    padding: const EdgeInsets.only(bottom: 4),
-                                    child: Row(
-                                      children: [
-                                        SizedBox(
-                                          width: 84,
-                                          child: Text(
-                                            '[$addr] $value',
-                                            style: const TextStyle(
-                                              fontSize: 11,
-                                            ),
-                                            overflow: TextOverflow.ellipsis,
-                                          ),
-                                        ),
-                                        const SizedBox(width: 6),
-                                        Expanded(
-                                          child: TextField(
-                                            controller: valueControllers[row],
-                                            focusNode: row < focusNodes.length
-                                                ? focusNodes[row]
-                                                : null,
-                                            keyboardType: TextInputType.number,
-                                            decoration: const InputDecoration(
-                                              isDense: true,
-                                              hintText: 'Новое значение',
-                                            ),
-                                          ),
-                                        ),
-                                      ],
-                                    ),
-                                  );
-                                },
+                            childWhenDragging: Opacity(
+                              opacity: 0.35,
+                              child: _buildRangeCard(
+                                range: range,
+                                index: index,
+                                changed: changed,
+                                valueControllers: valueControllers,
+                                focusNodes: focusNodes,
+                                currentValues: currentValues,
                               ),
                             ),
-                            SizedBox(
-                              height: 32,
-                              width: double.infinity,
-                              child: FilledButton(
-                                onPressed: () => _writeRangeValue(range),
-                                child: const Text('Записать'),
+                            child: DecoratedBox(
+                              decoration: BoxDecoration(
+                                border: isDropTarget
+                                    ? Border.all(
+                                        color: Colors.lightBlueAccent,
+                                        width: 2,
+                                      )
+                                    : null,
+                              ),
+                              child: _buildRangeCard(
+                                range: range,
+                                index: index,
+                                changed: changed,
+                                valueControllers: valueControllers,
+                                focusNodes: focusNodes,
+                                currentValues: currentValues,
                               ),
                             ),
-                          ],
-                        ),
+                          );
+                        },
                       );
                     },
                   );
                 },
               ),
             ),
           ],
         ),
       ),
     );
   }
 
+  Widget _buildRangeCard({
+    required RegisterRange range,
+    required int index,
+    required bool changed,
+    required List<TextEditingController> valueControllers,
+    required List<FocusNode> focusNodes,
+    required List<int> currentValues,
+  }) {
+    return Container(
+      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),
+      decoration: BoxDecoration(
+        border: Border.all(color: Colors.white24),
+        color: changed ? Colors.yellow.withValues(alpha: 0.18) : null,
+      ),
+      child: Column(
+        crossAxisAlignment: CrossAxisAlignment.start,
+        children: [
+          Row(
+            children: [
+              Expanded(
+                child: Text(
+                  '${range.name} | ${range.start} | ${range.typeLabel} | ${range.accessLabel}',
+                  style: const TextStyle(
+                    fontWeight: FontWeight.bold,
+                    fontSize: 12,
+                  ),
+                  maxLines: 2,
+                  overflow: TextOverflow.ellipsis,
+                ),
+              ),
+              IconButton(
+                visualDensity: VisualDensity.compact,
+                tooltip: 'Побитный редактор',
+                onPressed: () => _showBitEditor(range),
+                icon: const Icon(Icons.tune, size: 18),
+              ),
+              IconButton(
+                visualDensity: VisualDensity.compact,
+                onPressed: () => _removeRange(index),
+                icon: const Icon(
+                  Icons.delete_outline,
+                  size: 18,
+                ),
+              ),
+            ],
+          ),
+          Expanded(
+            child: ListView.builder(
+              itemCount: valueControllers.length,
+              itemBuilder: (BuildContext context, int row) {
+                final int addr = range.start + row;
+                final int value =
+                    row < currentValues.length ? currentValues[row] : 0;
+                return Padding(
+                  padding: const EdgeInsets.only(bottom: 4),
+                  child: Row(
+                    children: [
+                      SizedBox(
+                        width: 84,
+                        child: Text(
+                          '[$addr] $value',
+                          style: const TextStyle(
+                            fontSize: 11,
+                          ),
+                          overflow: TextOverflow.ellipsis,
+                        ),
+                      ),
+                      const SizedBox(width: 6),
+                      Expanded(
+                        child: TextField(
+                          controller: valueControllers[row],
+                          focusNode:
+                              row < focusNodes.length ? focusNodes[row] : null,
+                          keyboardType: TextInputType.number,
+                          decoration: const InputDecoration(
+                            isDense: true,
+                            hintText: 'Новое значение',
+                          ),
+                        ),
+                      ),
+                    ],
+                  ),
+                );
+              },
+            ),
+          ),
+          SizedBox(
+            height: 32,
+            width: double.infinity,
+            child: FilledButton(
+              onPressed: () => _writeRangeValue(range),
+              child: const Text('Записать'),
+            ),
+          ),
+        ],
+      ),
+    );
+  }
+
   Widget _buildRequestPanel() {
     return Card(
       child: Padding(
         padding: const EdgeInsets.all(8),
         child: Column(
           crossAxisAlignment: CrossAxisAlignment.start,
           children: [
             const Text(
               'Request Logs (MBAP + Modbus Request APU)',
               style: TextStyle(fontWeight: FontWeight.bold),
             ),
             const SizedBox(height: 6),
             Align(
               alignment: Alignment.centerLeft,
               child: TextButton.icon(
                 onPressed: _toggleRequestLogPause,
                 icon: Icon(_requestLogPaused ? Icons.play_arrow : Icons.pause),
                 label: Text(_requestLogPaused ? 'Resume' : 'Pause'),
               ),
             ),
             const SizedBox(height: 6),
             Expanded(
               child: ListView.builder(
                 itemCount: _requestLogView.length,
                 itemBuilder: (BuildContext context, int index) {
 
EOF
)